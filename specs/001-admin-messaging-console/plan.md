# Implementation Plan: Admin Messaging Console

**Branch**: `001-admin-messaging-console` | **Date**: 2025-10-19 | **Spec**: `specs/001-admin-messaging-console/spec.md`
**Input**: Feature specification from `/specs/001-admin-messaging-console/spec.md`

## Summary

Build an embedded admin experience that lets merchants configure the checkout messaging engine in real time. The plan introduces editable templates for threshold banners, switches for upsell logic, threshold management, preview tooling, and audit/reset controls. We will extend the React Router admin app with new routes, Prisma models for persisted configuration, and API endpoints so the checkout extension consumes the latest merchant settings without redeploys.

## Technical Context

**Language/Version**: TypeScript (Node 20+, React Router 7)  
**Primary Dependencies**: `@shopify/shopify-app-react-router`, Polaris web components (`@shopify/polaris-types`), Prisma ORM, Preact checkout extension runtime, Zod for runtime validation (new)  
**Storage**: Prisma → SQLite (dev) / PostgreSQL-compatible schema (prod ready)  
**Testing**: Vitest + Testing Library for UI, Prisma-driven unit tests with sqlite, Playwright manual checklist for embedded app flows  
**Target Platform**: Shopify embedded admin (desktop + mobile web) and Checkout UI Extension API 2025-10  
**Project Type**: Web monorepo (React Router admin app + checkout extension)  
**Performance Goals**: Admin save latency < 200 ms server response, checkout re-render under 100 ms with new settings, preview renders < 2 s  
**Constraints**: Must honor constitution (Shopify compliance, Preact pattern, localization). All new copy must ship with `en` + `fr` locales, and configuration limited to bundle-friendly JSON payloads (<25 KB).  
**Scale/Scope**: Supports single merchant store with ~10 thresholds, 5 upsell scenarios, and audit log depth of 20 entries per merchant.

## Constitution Check

- ✅ Principle I (Shopify Approval Compliance): plan keeps optional chaining, doc updates, and error handling as required deliverables.  
- ✅ Principle II (Checkout Integrity): extension continues to read settings via existing Preact runtime, no API regression.  
- ✅ Principle III (Documentation Driven): deliverables include updated guides (`docs/IMPLEMENTATION-STATUS.md`, `docs/NEXT-STEPS.md`, new admin handbook).  
- ✅ Principle IV (Verification & Observability): QA screenshots and Test plan updates scheduled.  
- ✅ Principle V (Privacy & Config Ownership): configuration stored via Prisma, no PII exported, merchant-controlled toggles.

## Project Structure

### Documentation (this feature)

```
specs/001-admin-messaging-console/
├── plan.md
├── research.md          # TBD – capture Shopify admin UI constraints & Polaris patterns
├── data-model.md        # TBD – Prisma models & API contracts
├── quickstart.md        # TBD – Merchant enablement steps
├── contracts/           # TBD – REST/GraphQL payload definitions
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```
app/
├── routes/
│   ├── app.messaging.tsx          # NEW admin console route (loader/action/UI)
│   ├── api.messaging-settings.ts  # NEW proxy for saving/loading config (JSON)
│   └── components/
│       ├── MessagingConsole.tsx   # NEW container using Polaris web components
│       ├── ThresholdEditor.tsx    # NEW modular editor
│       ├── UpsellEditor.tsx       # NEW toggle + preview controls
│       └── PreviewPane.tsx        # Embeds checkout preview iframe/screenshot
├── services/
│   └── messaging.server.ts        # NEW service layer for Prisma + validation
└── utils/
    └── validation.ts              # NEW Zod schemas shared by loaders/actions

prisma/
└── schema.prisma                  # Extend with MerchantMessagingConfig, ThresholdSetting, UpsellSetting, AuditLogEntry

extensions/nudun-messaging-engine/src/
├── config/
│   └── merchantSettingsLoader.js  # NEW fetcher to pull admin-configured data
└── utils/
    └── configAdapter.js           # Map persisted settings → runtime format

docs/
├── IMPLEMENTATION-STATUS.md       # Update progress + phase details
├── NEXT-STEPS.md                  # Update roadmap
├── user-guides/
│   └── admin-console.md           # NEW merchant documentation
└── troubleshooting/
    └── DEBUG-UPSELL.md            # Update with config-based diagnostics

tests/
├── admin/
│   ├── messagingConsole.test.tsx  # NEW Vitest/RTL coverage
│   └── services/messaging.server.test.ts # Prisma service tests
└── e2e/
    └── messaging-console.spec.ts  # OPTIONAL Playwright script placeholder
```

**Structure Decision**: Extend existing `app/` React Router hierarchy with a dedicated messaging console route and supporting components/services. Prisma models live in `prisma/schema.prisma`; checkout extension reads published configs via new utility modules. Documentation sits under `docs/` with a new merchant-facing guide.

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| None | Plan conforms to constitutional constraints | N/A |

## Milestones & Deliverables

### Phase 0 – Discovery & Alignment (2 days)
- Interview existing extension logs to confirm current dynamic messaging configuration flow and identify gaps.  
- Draft `research.md` capturing Polaris admin UX constraints, Shopify App Bridge patterns, and localization obligations.  
- Produce architecture sketch showing data flow: admin console → Prisma → checkout extension fetcher.

**Exit Criteria**: `research.md` committed, architecture diagram referenced in `docs/architecture/` (PNG or Mermaid), open questions resolved with product owner.

### Phase 1 – Data Modeling & Contracts (3 days)
- Extend `schema.prisma` with `MerchantMessagingConfig`, `ThresholdSetting`, `UpsellSetting`, and `ConfigAuditLog`.  
- Write `data-model.md` describing tables, relationships, and retention policies (30-day audit log rotation).  
- Define API payloads in `contracts/` (REST JSON): `GET /api/messaging-settings`, `PUT /api/messaging-settings`, `POST /api/messaging-settings/reset`, `GET /api/messaging-settings/audit`.  
- Author validation schemas in `Zod` (`app/utils/validation.ts`) and document them in contracts.

**Exit Criteria**: Migration SQL generated via `prisma migrate dev`, contracts validated with unit tests, constitution gate revalidated.

### Phase 2 – Admin Experience Implementation (5 days)
- Add route `app/routes/app.messaging.tsx` with loader/action that uses `authenticate.admin()` and new service layer.  
- Build UI components under `app/routes/components/` using Polaris web components: console shell, threshold list, upsell toggle, preview pane (iframe to checkout preview or screenshot stub).  
- Implement optimistic UI updates with React Router form submissions; use App Bridge toast for success/errors.  
- Add audit log view with pagination and reset confirmation modal.  
- Update Prisma service (`app/services/messaging.server.ts`) with CRUD functions, audit logging, and publish-to-extension hook (write to table consumed by extension).

**Exit Criteria**: UI functional in dev store, Vitest coverage for components/services ≥80%, manual QA checklist completed for desktop + mobile web.

### Phase 3 – Checkout Extension Integration (2 days)
- Create `extensions/nudun-messaging-engine/src/config/merchantSettingsLoader.js` to fetch settings via Admin proxy endpoint with optional caching.  
- Update extension entry (`Checkout.jsx`) to hydrate from loaded settings, with fallback to safe defaults when API unavailable.  
- Add locale-aware formatting for thresholds (USD/EUR) and optional chaining for missing fields.  
- Write integration tests / storybook-like mock to validate config parsing.

**Exit Criteria**: Extension displays merchant-configured thresholds and upsell toggles in preview, Cypress or manual capture confirming dynamic update without redeploy.

### Phase 4 – QA, Documentation & Launch (2 days)
- Update `docs/user-guides/admin-console.md` with step-by-step usage and screenshots.  
- Refresh `docs/IMPLEMENTATION-STATUS.md` and `docs/NEXT-STEPS.md` with milestone completion.  
- Produce test evidence: screenshots, Vitest output, Prisma migration logs.  
- Prepare changelog entry, draft release notes, and update `SHOPIFY-APPROVAL-CHECKLIST.md` sections touched.  
- Conduct security/privacy review (ensure no PII stored) and finalize deployment plan.

**Exit Criteria**: Documentation approved, production deployment runbook ready, final demo recorded.

## Data & API Changes
- **New Tables**: `MerchantMessagingConfig` (1:1 with shop), `ThresholdSetting` (1:many), `UpsellSetting`, `ConfigAuditLog`.  
- **Migrations**: Use `prisma migrate dev --name add_messaging_console` followed by `npm run setup`. Include rollback instructions in `data-model.md`.  
- **Endpoints**: Introduce authenticated JSON endpoints under `/app/api/messaging-settings`. Ensure CSRF tokens via React Router forms and session validation.  
- **Extension Fetching**: Checkout extension pulls published config via CDN-friendly JSON endpoint (cache-control max-age 60, stale-while-revalidate 300).

## Testing Strategy
- **Unit**: Vitest tests for Prisma service functions (mock Prisma client), validation schemas, and helper utilities.  
- **Component**: Testing Library for admin route components (form validation, preview toggles).  
- **Integration**: End-to-end happy path using Playwright against dev server (optional but recommended).  
- **Regression**: Add extension integration test harness to assert fallback defaults.  
- **Manual QA**: Shopify dev store walkthrough (desktop + mobile), verifying localization, accessibility (keyboard/ARIA), and error recovery.

## Observability & Audit
- Log admin configuration actions via `ConfigAuditLog` with actor, timestamp, and change diff.  
- Surface recent changes within console and expose export option (CSV) for merchants.  
- Add server-side logging (structured JSON) for validation failures and API errors.  
- Ensure audit logs respect retention policy (auto-truncate >20 entries via cron/background job or on-save cleanup).

## Documentation Deliverables
- `research.md`, `data-model.md`, `quickstart.md`, `contracts/*.md/json` filled and committed.  
- Merchant-facing guide `docs/user-guides/admin-console.md` with screenshots/gifs.  
- Update existing troubleshooting doc with new config reset steps.  
- Changelog entry in `CHANGELOG.md` under “Unreleased”.

## Risks & Mitigations
- **Risk**: Admin UI introduces latency due to Prisma transactions. → Mitigate with indexed columns and selective field loading.  
- **Risk**: Extension fails to fetch config (offline). → Provide default config fallback and toast notifying merchant in console.  
- **Risk**: Misconfigured thresholds break checkout messaging. → Enforce validation via Zod, surface inline form errors.  
- **Risk**: Audit log growth bloats DB. → Implement retention cleanup and document maintenance job.

## Dependencies & Coordination
- Requires product owner sign-off on copy and localization.  
- Coordinate with analytics team if new events added (optional).  
- Confirm Shopify API scopes already cover required reads/writes (likely `write_checkouts` not needed, only app DB).  
- Ensure localization team reviews `en` and `fr` strings before launch.

## Open Questions
- Do merchants require role-based access restrictions within admin console?  
- Should audit export integrate with existing analytics pipeline?  
- Preferred mechanism for preview panel (live iframe vs static screenshot service)?  
- Need to support additional locales beyond `en`/`fr` at launch?

## Next Steps
1. Populate `research.md`, `data-model.md`, `quickstart.md`, and contracts folder per Phase 0/1 outputs.  
2. Present plan to stakeholders for approval (product + engineering lead).  
3. After sign-off, run `/speckit.tasks` to generate executable task list aligned with phases.

